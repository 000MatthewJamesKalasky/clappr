var HlsjsPlayback=function(t,e,r){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function a(t,e,r){return e&&n(t.prototype,e),r&&n(t,r),t}function o(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function s(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,i)}return r}function l(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?s(Object(r),!0).forEach((function(e){o(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):s(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function c(t){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function u(t,e){return(u=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function h(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function p(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,i=c(t);if(e){var n=c(this).constructor;r=Reflect.construct(i,arguments,n)}else r=i.apply(this,arguments);return h(this,r)}}function _(t,e,r){return(_="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,r){var i=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=c(t)););return t}(t,e);if(i){var n=Object.getOwnPropertyDescriptor(i,e);return n.get?n.get.call(r):n.value}})(t,e,r||t)}function d(t){return function(t){if(Array.isArray(t))return y(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return y(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return y(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function y(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,i=new Array(e);r<e;r++)i[r]=t[r];return i}r=r&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r;var f=e.Utils.now,v=e.Utils.assign,g=e.Utils.listContainsIgnoreCase,m=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&u(t,e)}(o,t);var n=p(o);function o(){var t;i(this,o);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return(t=n.call.apply(n,[this].concat(a))).options.playback=l(l({},t.options),t.options.playback),t._minDvrSize=void 0===t.options.hlsMinimumDvrSize?60:t.options.hlsMinimumDvrSize,t._extrapolatedWindowNumSegments=t.options.playback&&void 0!==t.options.playback.extrapolatedWindowNumSegments?t.options.playback.extrapolatedWindowNumSegments:2,t._playbackType=e.Playback.VOD,t._lastTimeUpdate={current:0,total:0},t._lastDuration=null,t._playableRegionStartTime=0,t._localStartTimeCorrelation=null,t._localEndTimeCorrelation=null,t._playableRegionDuration=0,t._programDateTime=0,t._durationExcludesAfterLiveSyncPoint=!1,t._segmentTargetDuration=null,t._playlistType=null,t._recoverAttemptsRemaining=t.options.hlsRecoverAttempts||16,t}return a(o,[{key:"name",get:function(){return"hls"}},{key:"supportedVersion",get:function(){return{min:"0.4.11"}}},{key:"levels",get:function(){return this._levels||[]}},{key:"currentLevel",get:function(){return null===this._currentLevel||void 0===this._currentLevel?-1:this._currentLevel},set:function(t){this._currentLevel=t,this.trigger(e.Events.PLAYBACK_LEVEL_SWITCH_START),this.options.playback.hlsUseNextLevel?this._hls.nextLevel=this._currentLevel:this._hls.currentLevel=this._currentLevel}},{key:"isReady",get:function(){return this._isReadyState}},{key:"_startTime",get:function(){return this._playbackType===e.Playback.LIVE&&"EVENT"!==this._playlistType?this._extrapolatedStartTime:this._playableRegionStartTime}},{key:"_now",get:function(){return f()}},{key:"_extrapolatedStartTime",get:function(){if(!this._localStartTimeCorrelation)return this._playableRegionStartTime;var t=this._localStartTimeCorrelation,e=this._now-t.local,r=(t.remote+e)/1e3;return Math.min(r,this._playableRegionStartTime+this._extrapolatedWindowDuration)}},{key:"_extrapolatedEndTime",get:function(){var t=this._playableRegionStartTime+this._playableRegionDuration;if(!this._localEndTimeCorrelation)return t;var e=this._localEndTimeCorrelation,r=this._now-e.local,i=(e.remote+r)/1e3;return Math.max(t-this._extrapolatedWindowDuration,Math.min(i,t))}},{key:"_duration",get:function(){return this._extrapolatedEndTime-this._startTime}},{key:"_extrapolatedWindowDuration",get:function(){return null===this._segmentTargetDuration?0:this._extrapolatedWindowNumSegments*this._segmentTargetDuration}}],[{key:"version",get:function(){return VERSION}},{key:"HLSJS",get:function(){return r}}]),a(o,[{key:"_setup",value:function(){var t=this;this._ccIsSetup=!1,this._ccTracksUpdated=!1,this._hls=new r(v({},this.options.playback.hlsjsConfig)),this._hls.once(r.Events.MEDIA_ATTACHED,(function(){return t._hls.loadSource(t.options.src)})),this._hls.on(r.Events.LEVEL_LOADED,(function(e,r){return t._updatePlaybackType(e,r)})),this._hls.on(r.Events.LEVEL_UPDATED,(function(e,r){return t._onLevelUpdated(e,r)})),this._hls.on(r.Events.LEVEL_SWITCHING,(function(e,r){return t._onLevelSwitch(e,r)})),this._hls.on(r.Events.FRAG_LOADED,(function(e,r){return t._onFragmentLoaded(e,r)})),this._hls.on(r.Events.ERROR,(function(e,r){return t._onHLSJSError(e,r)})),this._hls.on(r.Events.SUBTITLE_TRACK_LOADED,(function(e,r){return t._onSubtitleLoaded(e,r)})),this._hls.on(r.Events.SUBTITLE_TRACKS_UPDATED,(function(){return t._ccTracksUpdated=!0})),this._hls.attachMedia(this.el)}},{key:"render",value:function(){return this._ready(),_(c(o.prototype),"render",this).call(this)}},{key:"_ready",value:function(){this._isReadyState=!0,this.trigger(e.Events.PLAYBACK_READY,this.name)}},{key:"_recover",value:function(t,r,i){if(this._recoveredDecodingError)if(this._recoveredAudioCodecError){e.Log.error("hlsjs: failed to recover",{evt:t,data:r}),i.level=e.PlayerError.Levels.FATAL;var n=this.createError(i);this.trigger(e.Events.PLAYBACK_ERROR,n),this.stop()}else this._recoveredAudioCodecError=!0,this._hls.swapAudioCodec(),this._hls.recoverMediaError();else this._recoveredDecodingError=!0,this._hls.recoverMediaError()}},{key:"_setupSrc",value:function(t){}},{key:"_startTimeUpdateTimer",value:function(){var t=this;this._timeUpdateTimer||(this._timeUpdateTimer=setInterval((function(){t._onDurationChange(),t._onTimeUpdate()}),100))}},{key:"_stopTimeUpdateTimer",value:function(){this._timeUpdateTimer&&(clearInterval(this._timeUpdateTimer),this._timeUpdateTimer=null)}},{key:"getProgramDateTime",value:function(){return this._programDateTime}},{key:"getDuration",value:function(){return this._duration}},{key:"getCurrentTime",value:function(){return Math.max(0,this.el.currentTime-this._startTime)}},{key:"getStartTimeOffset",value:function(){return this._startTime}},{key:"seekPercentage",value:function(t){var e=this._duration;t>0&&(e=this._duration*(t/100)),this.seek(e)}},{key:"seek",value:function(t){t<0&&(e.Log.warn("Attempt to seek to a negative time. Resetting to live point. Use seekToLivePoint() to seek to the live point."),t=this.getDuration()),this.dvrEnabled&&this._updateDvr(t<this.getDuration()-3),t+=this._startTime,_(c(o.prototype),"seek",this).call(this,t)}},{key:"seekToLivePoint",value:function(){this.seek(this.getDuration())}},{key:"_updateDvr",value:function(t){this.trigger(e.Events.PLAYBACK_DVR,t),this.trigger(e.Events.PLAYBACK_STATS_ADD,{dvr:t})}},{key:"_updateSettings",value:function(){this._playbackType===e.Playback.VOD?this.settings.left=["playpause","position","duration"]:this.dvrEnabled?this.settings.left=["playpause"]:this.settings.left=["playstop"],this.settings.seekEnabled=this.isSeekEnabled(),this.trigger(e.Events.PLAYBACK_SETTINGSUPDATE)}},{key:"_onHLSJSError",value:function(t,i){var n,a={code:"".concat(i.type,"_").concat(i.details),description:"".concat(this.name," error: type: ").concat(i.type,", details: ").concat(i.details),raw:i};if(i.response&&(a.description+=", response: ".concat(JSON.stringify(i.response))),i.fatal)if(this._recoverAttemptsRemaining>0)switch(this._recoverAttemptsRemaining-=1,i.type){case r.ErrorTypes.NETWORK_ERROR:switch(i.details){case r.ErrorDetails.MANIFEST_LOAD_ERROR:case r.ErrorDetails.MANIFEST_LOAD_TIMEOUT:case r.ErrorDetails.MANIFEST_PARSING_ERROR:case r.ErrorDetails.LEVEL_LOAD_ERROR:case r.ErrorDetails.LEVEL_LOAD_TIMEOUT:e.Log.error("hlsjs: unrecoverable network fatal error.",{evt:t,data:i}),n=this.createError(a),this.trigger(e.Events.PLAYBACK_ERROR,n),this.stop();break;default:e.Log.warn("hlsjs: trying to recover from network error.",{evt:t,data:i}),a.level=e.PlayerError.Levels.WARN,this._hls.startLoad()}break;case r.ErrorTypes.MEDIA_ERROR:e.Log.warn("hlsjs: trying to recover from media error.",{evt:t,data:i}),a.level=e.PlayerError.Levels.WARN,this._recover(t,i,a);break;default:e.Log.error("hlsjs: could not recover from error.",{evt:t,data:i}),n=this.createError(a),this.trigger(e.Events.PLAYBACK_ERROR,n),this.stop()}else e.Log.error("hlsjs: could not recover from error after maximum number of attempts.",{evt:t,data:i}),n=this.createError(a),this.trigger(e.Events.PLAYBACK_ERROR,n),this.stop();else{if(this.options.playback.triggerFatalErrorOnResourceDenied&&this._keyIsDenied(i))return e.Log.error("hlsjs: could not load decrypt key.",{evt:t,data:i}),n=this.createError(a),this.trigger(e.Events.PLAYBACK_ERROR,n),void this.stop();a.level=e.PlayerError.Levels.WARN,e.Log.warn("hlsjs: non-fatal error occurred",{evt:t,data:i})}}},{key:"_keyIsDenied",value:function(t){return t.type===r.ErrorTypes.NETWORK_ERROR&&t.details===r.ErrorDetails.KEY_LOAD_ERROR&&t.response&&t.response.code>=400}},{key:"_onTimeUpdate",value:function(){var t={current:this.getCurrentTime(),total:this.getDuration(),firstFragDateTime:this.getProgramDateTime()};this._lastTimeUpdate&&t.current===this._lastTimeUpdate.current&&t.total===this._lastTimeUpdate.total||(this._lastTimeUpdate=t,this.trigger(e.Events.PLAYBACK_TIMEUPDATE,t,this.name))}},{key:"_onDurationChange",value:function(){var t=this.getDuration();this._lastDuration!==t&&(this._lastDuration=t,_(c(o.prototype),"_onDurationChange",this).call(this))}},{key:"_onProgress",value:function(){if(this.el.buffered.length){for(var t=[],r=0,i=0;i<this.el.buffered.length;i++)t=[].concat(d(t),[{start:Math.max(0,this.el.buffered.start(i)-this._playableRegionStartTime),end:Math.max(0,this.el.buffered.end(i)-this._playableRegionStartTime)}]),this.el.currentTime>=t[i].start&&this.el.currentTime<=t[i].end&&(r=i);var n={start:t[r].start,current:t[r].end,total:this.getDuration()};this.trigger(e.Events.PLAYBACK_PROGRESS,n,t)}}},{key:"play",value:function(){this._hls||this._setup(),_(c(o.prototype),"play",this).call(this),this._startTimeUpdateTimer()}},{key:"pause",value:function(){this._hls&&(_(c(o.prototype),"pause",this).call(this),this.dvrEnabled&&this._updateDvr(!0))}},{key:"stop",value:function(){this._stopTimeUpdateTimer(),this._hls&&(_(c(o.prototype),"stop",this).call(this),this._hls.destroy(),delete this._hls)}},{key:"destroy",value:function(){this._stopTimeUpdateTimer(),this._hls&&(this._hls.destroy(),delete this._hls),_(c(o.prototype),"destroy",this).call(this)}},{key:"_updatePlaybackType",value:function(t,r){this._playbackType=r.details.live?e.Playback.LIVE:e.Playback.VOD,this._onLevelUpdated(t,r),this._ccTracksUpdated&&this._playbackType===e.Playback.LIVE&&this.hasClosedCaptionsTracks&&this._onSubtitleLoaded()}},{key:"_fillLevels",value:function(){this._levels=this._hls.levels.map((function(t,e){return{id:e,level:t,label:"".concat(t.bitrate/1e3,"Kbps")}})),this.trigger(e.Events.PLAYBACK_LEVELS_AVAILABLE,this._levels)}},{key:"_onLevelUpdated",value:function(t,i){this._segmentTargetDuration=i.details.targetduration,this._playlistType=i.details.type||null;var n=!1,a=!1,o=i.details.fragments,s=this._playableRegionStartTime,l=this._playableRegionDuration;if(0!==o.length){if(o[0].rawProgramDateTime&&(this._programDateTime=o[0].rawProgramDateTime),this._playableRegionStartTime!==o[0].start&&(n=!0,this._playableRegionStartTime=o[0].start),n)if(this._localStartTimeCorrelation){var c=this._localStartTimeCorrelation,u=this._now-c.local,h=(c.remote+u)/1e3;h<o[0].start?this._localStartTimeCorrelation={local:this._now,remote:1e3*o[0].start}:h>s+this._extrapolatedWindowDuration&&(this._localStartTimeCorrelation={local:this._now,remote:1e3*Math.max(o[0].start,s+this._extrapolatedWindowDuration)})}else this._localStartTimeCorrelation={local:this._now,remote:1e3*(o[0].start+this._extrapolatedWindowDuration/2)};var p=i.details.totalduration;if(this._playbackType===e.Playback.LIVE){var _=i.details.targetduration*((this.options.playback.hlsjsConfig||{}).liveSyncDurationCount||r.DefaultConfig.liveSyncDurationCount);_<=p?(p-=_,this._durationExcludesAfterLiveSyncPoint=!0):this._durationExcludesAfterLiveSyncPoint=!1}p!==this._playableRegionDuration&&(a=!0,this._playableRegionDuration=p);var d=o[0].start+p,y=s+l;if(d!==y)if(this._localEndTimeCorrelation){var f=this._localEndTimeCorrelation,v=this._now-f.local,g=(f.remote+v)/1e3;g>d?this._localEndTimeCorrelation={local:this._now,remote:1e3*d}:g<d-this._extrapolatedWindowDuration?this._localEndTimeCorrelation={local:this._now,remote:1e3*(d-this._extrapolatedWindowDuration)}:g>y&&(this._localEndTimeCorrelation={local:this._now,remote:1e3*y})}else this._localEndTimeCorrelation={local:this._now,remote:1e3*d};a&&this._onDurationChange(),n&&this._onProgress()}}},{key:"_onFragmentLoaded",value:function(t,r){this.trigger(e.Events.PLAYBACK_FRAGMENT_LOADED,r)}},{key:"_onSubtitleLoaded",value:function(){if(!this._ccIsSetup){this.trigger(e.Events.PLAYBACK_SUBTITLE_AVAILABLE);var t=this._playbackType===e.Playback.LIVE?-1:this.closedCaptionsTrackId;this.closedCaptionsTrackId=t,this._ccIsSetup=!0}}},{key:"_onLevelSwitch",value:function(t,r){this.levels.length||this._fillLevels(),this.trigger(e.Events.PLAYBACK_LEVEL_SWITCH_END),this.trigger(e.Events.PLAYBACK_LEVEL_SWITCH,r);var i=this._hls.levels[r.level];i&&(this.highDefinition=i.height>=720||i.bitrate/1e3>=2e3,this.trigger(e.Events.PLAYBACK_HIGHDEFINITIONUPDATE,this.highDefinition),this.trigger(e.Events.PLAYBACK_BITRATE,{height:i.height,width:i.width,bandwidth:i.bitrate,bitrate:i.bitrate,level:r.level}))}},{key:"getPlaybackType",value:function(){return this._playbackType}},{key:"isSeekEnabled",value:function(){return this._playbackType===e.Playback.VOD||this.dvrEnabled}},{key:"dvrEnabled",get:function(){return this._durationExcludesAfterLiveSyncPoint&&this._duration>=this._minDvrSize&&this.getPlaybackType()===e.Playback.LIVE}}]),o}(e.HTML5Video);return m.canPlay=function(t,e){var i=t.split("?")[0].match(/.*\.(.*)$/)||[],n=i.length>1&&"m3u8"===i[1].toLowerCase()||g(e,["application/vnd.apple.mpegurl","application/x-mpegURL"]);return!(!r.isSupported()||!n)},t.default=m,t}({},Clappr,Hls);
//# sourceMappingURL=hlsjs-playback.external.min.js.map
